<html>

<head>
    <meta charset="utf-8">
    <title>PyMO 游戏索引</title>

    <script src="https://cdn.staticfile.net/jquery/1.10.2/jquery.min.js"></script>

    <!-- Icons -->
    <link rel="icon" href="https://raw.githubusercontent.com/pymo/pymo.github.io/master/images/pymo.ico"
        type="image/x-icon" />
    <link rel="Shortcut Icon" href="https://raw.githubusercontent.com/pymo/pymo.github.io/master/images/pymo.ico"
        type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="144x144"
        href="https://raw.githubusercontent.com/pymo/pymo.github.io/master/images/pymo-icon-144.png" />
    <link rel="apple-touch-icon" sizes="114x114"
        href="https://raw.githubusercontent.com/pymo/pymo.github.io/master/images/pymo-icon-114.png" />
    <link rel="apple-touch-icon" sizes="72x72"
        href="https://raw.githubusercontent.com/pymo/pymo.github.io/master/images/pymo-icon-72.png" />
    <link rel="apple-touch-icon"
        href="https://raw.githubusercontent.com/pymo/pymo.github.io/master/images/pymo-icon-57.png" />
</head>

<body>
    <h1 align="center">PyMO游戏索引</h1>

    <div id="sources" align="center" hidden="true">
        <h2>选择一个源</h2>
        <br />
        <br />
        <br />
    </div>

    <div id="games" align="center" hidden="true">
        <a href="./index.html">返回索引列表</a>
        <br />
        <br />
        <br />
        <h2 id="games-source-name"></h2>
        <p id="games-source-desc"></p>
        <br />

        <table border="1" cellspacing="0">
            <thead>
                <tr>
                    <th>游戏名称</th>
                    <th>游戏ID</th>
                    <th>包含NSFW内容</th>
                    <th>移植者</th>
                    <th>发布时间</th>
            </thead>
            <tbody id="games-list">
            </tbody>
        </table>
    </div>

    <script type="text/javascript">

        function showSourcesList(sources) {
            let div = document.getElementById("sources");
            div.hidden = false;

            sources.forEach(src => {
                var html = "";
                html += "<a href='./index.html?source=" + src.id + "'><h3>" + src.name + "</h3></a>";
                html += "<p>" + src.desc + "</p>";
                html += "<br />"

                div.innerHTML += html;
            });
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {return pair[1];}
            }
            return false;
        }

        function showGameList(source) {
            document.getElementById("games").hidden = false;
            document.getElementById("games-source-name").innerHTML = source.name;
            document.getElementById("games-source-desc").innerHTML = source.desc;

            let gameList = document.getElementById("games-list");

            let addGameToList = function (game) {
                var html = "";
                html += "<tr>";

                html += "<td><a href='./index.html?source=" + source.id + "&game=" + game.baidu_folder + "'>" + game.title + "</a></td>";
                html += "<td>" + game.baidu_folder + "</td>";
                html += "<td>" + (game.contains_h ? "√" : "") + "</td>";
                html += "<td>" + game.author + "</td>";
                html += "<td>" + game.publish_date + "</td>";

                html += "</tr>";
                gameList.innerHTML += html;
            }

            fetch(source.url)
                .then((x) => x.json())
                .then((json) => json.forEach(addGameToList));
        }

        function main(sources) {
            let sourceId = getQueryVariable("source");
            let gameName = getQueryVariable("game");

            if (sourceId == false && gameName == false) {
                showSourcesList(sources);
                return;
            }

            let source = sources.find((s) => s.id == sourceId);
            if (sourceId != false)
                showGameList(source);
        }

        fetch("./sources.json")
            .then((response) => response.json())
            .then(main);
    </script>
</body>

</html>